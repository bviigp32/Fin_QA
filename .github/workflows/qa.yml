name: FinQA Automated Testing 

# 언제 실행할까? -> main 브랜치에 코드가 올라오면(push) 실행!
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  qa-test-runner:
    runs-on: ubuntu-latest # 깃허브가 제공하는 리눅스 서버 대여

    steps:
    # 1. 내 코드 내려받기
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. 파이썬 설치
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    # 3. 라이브러리 설치
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # 4. 모의 서버(Mock Server) 백그라운드 실행
    # 서버를 켜두고(&) 5초 정도 기다렸다가 테스트를 시작함
    - name: Start Mock Server
      run: |
        nohup python -m uvicorn mock_server:app --port 8000 &
        sleep 5 

    # 5. 테스트 실행 (Pytest)
    # 서버에 버그가 있어서 실패하더라도 파이프라인이 멈추지 않게 하려면 'continue-on-error'를 쓸 수 있지만
    # QA는 실패를 알리는 게 목적이므로 그냥 둡니다. (빨간불이 뜨는 게 정상!)
    - name: Run Pytest
      run: |
        pytest -v